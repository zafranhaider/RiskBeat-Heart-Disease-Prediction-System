{% extends 'index.html' %}
{% load static %}
{% block body %}
<section class="section-padding" style="padding-top:70px">
  <div class="container"><div class="row"><div class="col-lg-8 mx-auto">

    <!-- Add / Overwrite form -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h3 class="mb-0">Manage Your Weekly Availability</h3>
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'manage_slots' %}">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group col-md-3">
              <label>Day</label>
              <select name="day" class="form-control" required>
                <option value="" disabled selected>— select day —</option>
                {% for d in slots_by_day %}<option value="{{ d.day }}">{{ d.day }}</option>{% endfor %}
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Start Time</label>
              <input type="time" name="start_time" class="form-control" required>
            </div>
            <div class="form-group col-md-3">
              <label>End Time</label>
              <input type="time" name="end_time" class="form-control" required>
            </div>
            <div class="form-group col-md-3">
              <label>Duration (min)</label>
              <input type="number" name="slot_duration" class="form-control" value="30" min="15" max="120">
            </div>
          </div>
          <button class="btn btn-primary">Save / Overwrite</button>
        </form>
      </div>
    </div>

    <!-- Display each day, toggle & slots -->
    {% for d in slots_by_day %}
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">{{ d.day }}</h4>
        <button class="btn btn-sm {% if d.is_available %}btn-success{% else %}btn-secondary{% endif %}"
                onclick="toggleDay('{{ d.day }}', this)">
          {{ d.is_available|yesno:"Available,Unavailable" }}
        </button>
      </div>
      <div class="card-body p-0">
        {% if d.slots %}
        <ul class="list-group list-group-flush">
          {% for slot in d.slots %}
          <li class="list-group-item d-flex justify-content-between">
            <div>
              <strong>{{ slot.start_time|time:"h:i A" }} – {{ slot.end_time|time:"h:i A" }}</strong>
              ({{ slot.slot_duration }} min)
            </div>
            <div>
              <button class="btn btn-sm {% if slot.is_active %}btn-success{% else %}btn-secondary{% endif %}"
                      onclick="toggleSlot({{ slot.id }}, this)">
                <i class="fas fa-{{ slot.is_active|yesno:'check-circle,times-circle' }}"></i>
                {{ slot.is_active|yesno:"Active,Inactive" }}
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteSlot({{ slot.id }}, this)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
          <div class="p-3 text-center text-muted">No slots for {{ d.day }}</div>
        {% endif %}
      </div>
    </div>
    {% endfor %}

  </div></div></div>
</section>

<script>
  const csrftoken = '{{ csrf_token }}';
  function headers() {
    return { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' };
  }

  function toggleDay(day, btn) {
    btn.disabled = true;
    fetch("{% url 'toggle_day' 'DAY' %}".replace('DAY', day), {
      method: 'POST', headers: headers()
    })
    .then(r=>r.json())
    .then(js=>{
      if(js.success){
        btn.classList.toggle('btn-success');
        btn.classList.toggle('btn-secondary');
        btn.textContent = js.is_available? 'Available':'Unavailable';
      }
    })
    .finally(()=>btn.disabled=false);
  }

  function toggleSlot(id, btn) {
    btn.disabled = true;
    fetch("{% url 'toggle_slot' 0 %}".replace('0', id), {
      method: 'POST', headers: headers()
    })
    .then(r=>r.json())
    .then(js=>{
      if(js.success){
        btn.classList.toggle('btn-success');
        btn.classList.toggle('btn-secondary');
        btn.innerHTML = js.is_active
          ? '<i class="fas fa-check-circle"></i> Active'
          : '<i class="fas fa-times-circle"></i> Inactive';
      }
    })
    .finally(()=>btn.disabled=false);
  }

  function deleteSlot(id, btn) {
    if(!confirm('Delete this slot?')) return;
    btn.disabled = true;
    fetch("{% url 'delete_slot' 0 %}".replace('0', id), {
      method: 'POST', headers: headers()
    })
    .then(r=>r.json())
    .then(js=>{
      if(js.success) btn.closest('li').remove();
      else alert('Could not delete');
    })
    .finally(()=>btn.disabled=false);
  }
</script>
{% endblock %}
